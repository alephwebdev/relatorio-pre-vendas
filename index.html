<!doctype html>
<html lang="pt-BR" data-bs-theme="light">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Relatório Pré-vendas</title>
        <!-- Bootstrap CSS -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
        <!-- Bootstrap Icons -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
        <!-- Tailwind CSS (preflight disabled to avoid conflicts with Bootstrap) -->
        <script src="https://cdn.tailwindcss.com"></script>
        <script>
            tailwind.config = {
                corePlugins: { preflight: false, container: false },
                theme: {
                    extend: {
                        colors: {
                            primary: '#1d1d1b',
                            accent: '#CF1118'
                        }
                    }
                }
            };
        </script>
        <!-- Custom styles -->
        <link rel="stylesheet" href="./styles.css" />
    </head>
    <body class="bg-light min-h-screen bg-gradient-to-b from-gray-100 to-white text-gray-800 antialiased">
        <main class="py-4 min-h-screen d-flex justify-content-center align-items-center" id="app" style="width: 100%; max-width: 1440px; margin: 0 auto; padding-left: 5%; padding-right: 5%;">
            <!-- Login -->
            <section id="login-view" class="card border-0 shadow-lg mx-auto rounded-lg overflow-hidden login-card">
                <div class="card-header login-header d-flex align-items-center">
                    <h1 class="h4 mb-0"><i class="bi bi-person-check me-2"></i> Entrar</h1>
                </div>
                <div class="card-body p-4">
                    <p class="text-muted mb-4">Acesse com seu <span class="accent-color fw-bold">ID</span> de conta (pré-definido).</p>
                    <form id="login-form" onsubmit="event.preventDefault();">
                        <div class="mb-4">
                            <label for="login-id" class="form-label">ID da Conta <i class="bi bi-key-fill accent-color small ms-1"></i></label>
                            <input id="login-id" class="form-control login-input" placeholder="Ex.: PV001" autocomplete="off" required />
                        </div>
                        <button type="submit" class="btn login-btn w-100">
                            <i class="bi bi-box-arrow-in-right me-1"></i> Entrar
                        </button>
                    </form>
                    
                    <div class="mt-4 signup-section" id="signupAccordion">
                        <div class="card">
                            <div class="card-header p-0">
                                <button class="signup-toggle w-100 text-start p-3 border-0 bg-light d-flex align-items-center" id="signupToggle" type="button" onclick="toggleSignup()">
                                    <i class="bi bi-person-plus me-2 accent-color"></i> Não tem conta? Cadastrar
                                    <i class="bi bi-chevron-down ms-auto signup-icon"></i>
                                </button>
                            </div>
                            <div id="signupCollapse" class="signup-collapse">
                                <div class="card-body bg-white">
                                    <form id="signup-form">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="signup-name" class="form-label">Nome da Conta</label>
                                                <input id="signup-name" class="form-control login-input" placeholder="Ex.: João Silva" />
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="signup-id" class="form-label">ID desejado</label>
                                                <input id="signup-id" class="form-control login-input" placeholder="Ex.: PV001" />
                                            </div>
                                        </div>
                                        <button class="btn signup-btn" type="submit" id="signup-submit-btn">
                                            <i class="bi bi-person-add me-1"></i> Cadastrar
                                        </button>
                                        <p class="text-muted small mt-2">Cadastro simples; sem senha. Guarde o ID.</p>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="login-error" class="alert alert-danger mt-4 d-none"></div>
                </div>
            </section>

            <!-- App -->
            <section id="app-view" class="d-none">
                <nav class="navbar navbar-dark mb-4 rounded-lg shadow-md user-nav">
                    <div class="container-fluid">
                        <div class="d-flex align-items-center w-100 justify-content-between">
                            <div class="d-flex align-items-center user-info-container">
                                <img id="account-avatar" class="user-avatar me-2 d-none" alt="Avatar" />
                                <i id="account-avatar-fallback" class="bi bi-person-circle me-2 fs-5"></i>
                                <span class="user-name text-white fw-bold me-3" id="account-name"></span>
                                <span class="user-id-badge me-3" id="account-id"></span>
                                <span class="day-badge" id="current-day"></span>
                            </div>
                            <div class="d-flex align-items-center gap-2 position-relative">
                                <button id="theme-btn" class="btn btn-outline-light btn-sm theme-btn" title="Tema">
                                    <i class="bi bi-palette"></i>
                                </button>
                                <button id="logout-btn" class="btn btn-outline-light btn-sm logout-btn">
                                    <i class="bi bi-box-arrow-right me-1"></i> Sair
                                </button>
                                <div id="theme-palette" class="theme-palette d-none"></div>
                            </div>
                        </div>
                    </div>
                </nav>

                <!-- Configurações do Relatório -->
                <div class="card config-card mb-3 border-0">
                    <div class="card-header config-header">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-calendar-date me-2"></i>
                            <h5 class="mb-0">Configurações do Relatório</h5>
                        </div>
                    </div>
                    <div class="card-body p-3">
                        <!-- Configurações de Data e Horário -->
                        <div class="config-section mb-3">
                            <h6 class="config-subtitle mb-2">
                                <i class="bi bi-clock me-1 text-muted"></i>Data e Horário
                            </h6>
                            <div class="row g-2">
                                <div class="col-lg-4">
                                    <label for="date" class="form-label">Data</label>
                                    <input type="date" id="date" class="form-control config-input" />
                                </div>
                                <div class="col-lg-4">
                                    <label for="start-time" class="form-label">Início</label>
                                    <input type="time" id="start-time" class="form-control config-input" value="08:00" />
                                </div>
                                <div class="col-lg-4">
                                    <label for="end-time" class="form-label">Fim</label>
                                    <input type="time" id="end-time" class="form-control config-input" value="18:00" />
                                </div>
                            </div>
                        </div>

                        <!-- Ações do Sistema -->
                        <div class="config-section">
                            <h6 class="config-subtitle mb-2">
                                <i class="bi bi-gear me-1 text-muted"></i>Ações
                            </h6>
                            <div class="row g-2">
                                <div class="col-lg-4">
                                    <button id="generate-report-btn" class="btn btn-action btn-primary w-100">
                                        <i class="bi bi-file-earmark-text me-2"></i>
                                        Gerar Relatório
                                    </button>
                                </div>
                                <div class="col-lg-4">
                                    <button id="history-btn" class="btn btn-action btn-outline-secondary w-100">
                                        <i class="bi bi-clock-history me-2"></i>
                                        Histórico
                                    </button>
                                </div>
                                <div class="col-lg-4">
                                    <button id="structure-btn" class="btn btn-action btn-outline-secondary w-100">
                                        <i class="bi bi-gear me-2"></i>
                                        Estrutura
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Indicador de salvamento -->
                            <div style="display: none;"  class="mt-2 text-center">
                                <span id="save-indicator" class="save-indicator"></span>
                            </div>
                        </div>
                    </div>
                            <!-- Progress Bar Semanal -->
                            <div class="progress-container mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="progress-label">
                                        <i class="bi bi-trophy me-1 text-warning"></i>
                                        Meta Semanal:
                                    </span>
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="progress-stats">
                                            <span id="current-ganhos">0</span> / <span class="target">150</span>
                                        </span>
                                        <button id="refresh-progress-btn" class="btn btn-sm btn-outline-secondary" title="Atualizar ganhos">
                                            <i class="bi bi-arrow-clockwise"></i>
                                        </button>
                                        <button id="weekly-history-btn" class="btn btn-sm btn-outline-primary" title="Ver histórico de metas semanais">
                                            <i class="bi bi-calendar-week"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="progress mb-2" style="height: 20px;">
                                    <div id="progress-bar" class="progress-bar progress-bar-striped" 
                                         role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="150">
                                        0%
                                    </div>
                                </div>
                                <div class="period-info text-center">
                                    <span class="period-label">Período:</span>
                                    <span id="week-dates" class="period-badge"></span>
                                    <span id="weekly-period" class="motivation-text"></span>
                                </div>
                                
                                <!-- Detalhes diários -->
                                <div id="daily-details" class="mt-3 p-2 bg-light rounded" style="display: none;">
                                    <div class="text-center mb-2">
                                        <strong class="text-muted">Ganhos Diários</strong>
                                    </div>
                                    <div id="daily-breakdown" class="row g-1 text-center">
                                        <!-- Será preenchido dinamicamente -->
                                    </div>
                                    <div class="text-center mt-2">
                                        <button id="toggle-daily-details" class="btn btn-sm btn-outline-secondary">
                                            <i class="bi bi-eye"></i> Ver detalhes
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Seção de Produtos/Interesses -->
                <div class="card products-card border-0">
                    <div class="card-header products-header">
                        <div class="d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-box-seam me-2"></i>
                                <h5 class="mb-0">Produtos / Interesses</h5>
                            </div>
                            <span class="badge bg-light text-dark products-count" id="products-count">0 produtos</span>
                        </div>
                    </div>
                    <div class="card-body p-2">
                        <div id="products-grid" class="products-grid">
                            <!-- Os produtos serão renderizados aqui dinamicamente -->
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <!-- Sistema de Notificações -->
        <div id="toast-container" class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;">
        </div>

        <!-- Report Modal -->
        <div class="modal fade" id="report-modal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white flex items-center gap-2">
                        <h5 class="modal-title"><i class="bi bi-file-earmark-text"></i> Gerar Relatório</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="report-date" class="form-label">Data</label>
                                <input type="date" id="report-date" class="form-control focus:ring-2 focus:ring-primary/30 focus:border-primary transition" />
                            </div>
                            <div class="col-md-6 mb-3 d-flex align-items-end">
                                <div class="form-check">
                                    <input type="checkbox" id="sum-selected" class="form-check-input" checked />
                                    <label class="form-check-label" for="sum-selected">Somar contas selecionadas</label>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Contas</label>
                            <div id="accounts-list" class="border rounded p-3 bg-light divide-y divide-gray-200 space-y-2" style="max-height: 300px; overflow-y: auto;"></div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary transition-colors" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle"></i> Cancelar
                        </button>
                        <button id="run-report-btn" type="button" class="btn btn-primary transition-colors">
                            <i class="bi bi-play-circle"></i> Gerar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- History Modal -->
        <div class="modal fade" id="history-modal" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header bg-info text-white">
                        <h5 class="modal-title">
                            <i class="bi bi-clock-history me-2"></i>Histórico de Relatórios
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Filtros de busca -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">
                                    <i class="bi bi-funnel me-1"></i>Filtros de Busca
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-5">
                                        <label for="hist-start" class="form-label">Data Início</label>
                                        <input type="date" id="hist-start" class="form-control" />
                                    </div>
                                    <div class="col-md-5">
                                        <label for="hist-end" class="form-label">Data Fim</label>
                                        <input type="date" id="hist-end" class="form-control" />
                                    </div>
                                    <div class="col-md-2 d-flex align-items-end">
                                        <button id="run-history-btn" type="button" class="btn btn-primary w-100">
                                            <i class="bi bi-search me-1"></i>Buscar
                                        </button>
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-12">
                                        <div class="form-check">
                                            <input type="checkbox" id="hist-sum-period" class="form-check-input" />
                                            <label class="form-check-label" for="hist-sum-period">
                                                <strong>Somar todo o período</strong>
                                                <small class="d-block text-muted">Agrupa todos os dias em um relatório consolidado</small>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Resultados -->
                        <div class="card">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">
                                    <i class="bi bi-file-earmark-text me-1"></i>Resultados
                                </h6>
                            </div>
                            <div class="card-body p-2">
                                <div id="history-results" class="history-results-container">
                                    <div class="text-center py-4 text-muted">
                                        <i class="bi bi-search fs-1 d-block mb-2"></i>
                                        <p>Use os filtros acima para buscar relatórios históricos</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle me-1"></i>Fechar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Final Report Modal -->
    <div class="modal fade" id="final-report-modal" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
            <div class="modal-header bg-success text-white flex items-center gap-2">
                        <h5 class="modal-title"><i class="bi bi-file-earmark-text"></i> Relatório Final</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> Você pode editar o texto do relatório antes de enviar ou copiar.
                        </div>
                        <div class="mb-3">
                            <label for="final-report-text" class="form-label">Texto do Relatório</label>
                <textarea id="final-report-text" class="form-control font-mono text-sm leading-6" rows="15" style="font-family: 'Courier New', monospace;"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
            <button type="button" class="btn btn-secondary transition-colors" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle"></i> Cancelar
                        </button>
            <button id="copy-final-report-btn" type="button" class="btn btn-outline-primary transition-colors">
                            <i class="bi bi-clipboard"></i> Copiar Texto
                        </button>
            <a id="whatsapp-final-link" class="btn btn-success transition-colors" target="_blank" rel="noopener">
                            <i class="bi bi-whatsapp"></i> Enviar no WhatsApp
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal para editar estrutura -->
        <div class="modal fade" id="structure-modal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-secondary text-white">
                        <h5 class="modal-title">
                            <i class="bi bi-box-seam me-2"></i>Editar Produtos/Interesses
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        
                        
                        <div class="mb-3">
                            <button id="add-product-struct" type="button" class="btn btn-primary">
                                <i class="bi bi-plus-circle me-1"></i>Adicionar Produto
                            </button>
                        </div>
                        
                        <div id="structure-editor" class="structure-editor">
                            <!-- Editor será renderizado aqui -->
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle me-1"></i>Cancelar
                        </button>
                        <button id="save-structure-btn" type="button" class="btn btn-success">
                            <i class="bi bi-check-circle me-1"></i>Salvar Alterações
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal para histórico de metas semanais -->
        <div class="modal fade" id="weekly-history-modal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title">
                            <i class="bi bi-calendar-week me-2"></i>Histórico de Metas Semanais
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0">Histórico de Performance Semanal</h6>
                            <button id="refresh-history-btn" class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-arrow-clockwise me-1"></i>Atualizar
                            </button>
                        </div>
                        
                        <!-- Filtros -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="filter-year" class="form-label small">Ano</label>
                                <select id="filter-year" class="form-select form-select-sm">
                                    <option value="">Todos os anos</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="filter-month" class="form-label small">Mês</label>
                                <select id="filter-month" class="form-select form-select-sm">
                                    <option value="">Todos os meses</option>
                                    <option value="0">Janeiro</option>
                                    <option value="1">Fevereiro</option>
                                    <option value="2">Março</option>
                                    <option value="3">Abril</option>
                                    <option value="4">Maio</option>
                                    <option value="5">Junho</option>
                                    <option value="6">Julho</option>
                                    <option value="7">Agosto</option>
                                    <option value="8">Setembro</option>
                                    <option value="9">Outubro</option>
                                    <option value="10">Novembro</option>
                                    <option value="11">Dezembro</option>
                                </select>
                            </div>
                            <div class="col-md-4 d-flex align-items-end">
                                <button id="clear-filters-btn" class="btn btn-sm btn-outline-secondary w-100">
                                    <i class="bi bi-x-circle me-1"></i>Limpar Filtros
                                </button>
                            </div>
                        </div>
                        
                        <div id="weekly-history-loading" class="text-center py-4" style="display: none;">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Carregando...</span>
                            </div>
                            <p class="mt-2 text-muted">Carregando histórico...</p>
                        </div>
                        
                        <div id="weekly-history-content">
                            <div class="table-responsive">
                                <table class="table table-hover table-bordered align-middle" id="weekly-history-table">
                                    <thead class="table-light">
                                        <tr>
                                            <th scope="col" class="border-start border-end">
                                                <i class="bi bi-calendar-range me-1"></i>Período
                                            </th>
                                            <th scope="col" class="border-end text-center">
                                                <i class="bi bi-target me-1"></i>Meta
                                            </th>
                                            <th scope="col" class="border-end text-center">
                                                <i class="bi bi-graph-up me-1"></i>Resultado
                                            </th>
                                            <th scope="col" class="border-end text-center">
                                                <i class="bi bi-percent me-1"></i>Performance
                                            </th>
                                            <th scope="col" class="border-end text-center">
                                                <i class="bi bi-award me-1"></i>Status
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody id="weekly-history-tbody">
                                        <!-- Os dados serão renderizados aqui -->
                                    </tbody>
                                </table>
                            </div>
                            
                            <div id="weekly-history-empty" class="text-center py-5" style="display: none;">
                                <i class="bi bi-calendar-x text-muted" style="font-size: 3rem;"></i>
                                <h6 class="text-muted mt-3">Nenhum histórico encontrado</h6>
                                <p class="text-muted">O histórico de metas semanais aparecerá aqui conforme você for completando as semanas.</p>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle me-1"></i>Fechar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Firebase config (user must create firebase-config.js from sample) -->
        <script src="./firebase-config.js"></script>
        <!-- n8n webhook config (optional - can be configured directly in main.js) -->
        <script src="./n8n-config.js"></script>
        <!-- Firebase SDKs (compat builds for simplicity) -->
        <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
        <!-- Bootstrap JS -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
        <!-- Main application -->
        <script src="./main.js"></script>
        
        <!-- Script para controlar o toggle de cadastro sem depender do Bootstrap -->
        <script>
            function toggleSignup() {
                const collapse = document.getElementById('signupCollapse');
                const icon = document.querySelector('.signup-icon');
                
                if (collapse.classList.contains('show')) {
                    collapse.classList.remove('show');
                    icon.classList.remove('rotate');
                } else {
                    collapse.classList.add('show');
                    icon.classList.add('rotate');
                }
            }
            
            function handleSignup(event) {
                event.preventDefault();
                // O formulário de cadastro é processado pelo main.js
                // Isso é apenas para prevenir o comportamento padrão do botão
            }
            
            // Garantir que o formulário de login não cause recarregamento da página
            document.getElementById('login-form').addEventListener('submit', function(event) {
                event.preventDefault();
                // O login é processado pelo main.js
            });
        </script>
    </body>
</html>