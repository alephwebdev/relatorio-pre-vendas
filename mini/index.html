<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Relatório Pré-vendas - Mini</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <!-- Tailwind CSS (preflight disabled) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { corePlugins: { preflight: false, container: false } };
  </script>
  <link rel="stylesheet" href="../styles.css" />
  <style>
    /* Compact adjustments for mini version */
  body { padding: 0; overflow-x: hidden; }
    .login-card { max-width: 380px; }
  .config-card, .products-card { margin-bottom: .5rem; }
  /* 2 colunas super compactas */
  .products-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); gap: .4rem; }
  .navbar { padding: .2rem .4rem; }
  .btn-action { padding: .3rem .5rem; font-size: .75rem; }
  /* Garantir que nada extrapole a largura e evitar scroll interno */
  #app { max-height: none; overflow: visible; }
  #app * { min-width: 0; }
    /* Remover sombras e bordas arredondadas para tudo dentro do app */
  #app *, #app .card, #app .modal-content { box-shadow: none !important; border-radius: 0 !important; }
  .progress, .progress-bar { border-radius: 0 !important; box-shadow: none !important; }
    /* Divisor simples */
    .mini-divider { height: 8px; border-top: 1px solid var(--border-color); margin: .25rem 0 .5rem; }
  /* Tipografia mais compacta e alinhada à esquerda */
  #app { text-align: left; }
  #app .btn, #app .form-control, #app label, #app .badge, #app .modal, #app .card, #app .nav, #app .navbar { font-size: .74rem; }
  #app .small, #app small { font-size: .7rem; }
  /* Progresso com mais respiro */
  .progress-container { padding: 1rem; }
  /* Barra + número lado a lado */
  .progress-row { display: flex; align-items: center; gap: .5rem; }
  .progress-row .progress { flex: 1 1 auto; height: 14px !important; }
  .progress-nums { white-space: nowrap; font-weight: 700; color: var(--accent-color); font-size: .78rem; }
  /* Texto dentro da barra com mais padding */
  #app .progress-bar { padding: 0 8px; font-size: .7rem; line-height: 1; }
  /* Header ainda mais limpo */
  .user-nav { background: #fff !important; border-bottom: 1px solid var(--border-color) !important; }
  /* Produtos ainda menores (somente no mini) */
  #app .product-card-inline { padding: .35rem; min-height: 42px; flex-direction: column; align-items: stretch; gap: .25rem; }
  #app .product-name { font-size: .75rem; line-height: 1.2; display: -webkit-box; -webkit-line-clamp: 2; line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; white-space: normal; }
  #app .product-value-inline { text-align: center; }
  #app .product-controls-inline { justify-content: space-between; gap: .25rem; }
  #app .btn-control { width: 24px; height: 24px; font-size: .7rem; }
  #app .product-value-inline { width: 46px; height: 24px; font-size: .7rem; }
  /* Esconder infos extras, mantendo elementos para o main.js */
  .header-extras { display: none !important; }
  .period-info { display: none !important; }
  </style>
  <style>
    /* Colapsed (mini) mode: show only tiny progress bar + keep navbar for toggle */
    :root.mini-collapsed .config-card,
    :root.mini-collapsed .products-card,
    :root.mini-collapsed #structure-modal,
    :root.mini-collapsed #report-modal,
    :root.mini-collapsed #history-modal,
    :root.mini-collapsed #final-report-modal,
    :root.mini-collapsed #weekly-history-modal { display: none !important; }

  :root.mini-collapsed .progress-container { padding: .5rem .6rem; }
    :root.mini-collapsed .progress-container .progress-label,
    :root.mini-collapsed .progress-container .progress-stats,
    :root.mini-collapsed .progress-container .period-info { display: none !important; }
  :root.mini-collapsed .progress-container .progress { height: 10px !important; }
  :root.mini-collapsed .progress-nums { display: inline-block; font-size: .72rem; margin-left: .4rem; }
  :root.mini-collapsed nav.user-nav { padding: .2rem .4rem !important; }
  :root.mini-collapsed .mini-divider { display: none; }
  </style>
</head>
<body class="bg-light">
  <main id="app" class="p-2" style="max-width:360px;min-width:360px;">
    <!-- Reuse the same DOM from main app by embedding main app's HTML sections -->
    <!-- For mini we only need login + top sections + products -->
    <section id="login-view" class="card border-0 shadow-lg mx-auto rounded-lg overflow-hidden login-card">
      <div class="card-header login-header d-flex align-items-center">
        <h1 class="h6 mb-0"><i class="bi bi-person-check me-2"></i> Entrar</h1>
      </div>
      <div class="card-body p-3">
        <form id="login-form" onsubmit="event.preventDefault();">
          <div class="mb-3">
            <label for="login-id" class="form-label">ID da Conta</label>
            <input id="login-id" class="form-control login-input" placeholder="Ex.: PV001" autocomplete="off" required />
          </div>
          <button type="submit" class="btn login-btn w-100">
            <i class="bi bi-box-arrow-in-right me-1"></i> Entrar
          </button>
        </form>
        <div id="login-error" class="alert alert-danger mt-3 d-none"></div>
      </div>
    </section>

    <section id="app-view" class="d-none mt-2">
  <nav class="navbar navbar-dark user-nav" style="padding:.35rem .5rem;">
        <div class="container-fluid">
          <div class="d-flex align-items-center w-100 justify-content-between">
            <div class="d-flex align-items-center user-info-container" style="gap:.25rem;overflow:hidden;">
              <i id="account-avatar-fallback" class="bi bi-person-circle me-1" style="font-size:1rem;"></i>
              <span class="user-name fw-bold me-1 text-truncate" id="account-name" style="max-width:140px;font-size:.85rem;"></span>
              <span class="user-id-badge me-1 header-extras" id="account-id" style="font-size:.65rem;"></span>
              <span class="day-badge header-extras" id="current-day" style="font-size:.65rem;"></span>
            </div>
    <div class="d-flex align-items-center gap-1">
              <button id="generate-report-btn" class="btn btn-outline-secondary btn-sm" title="Gerar relatório" style="width:26px;height:26px;padding:0;display:flex;align-items:center;justify-content:center;">
                <i class="bi bi-file-earmark-text"></i>
              </button>
              <button id="toggle-mini-btn" class="btn btn-outline-secondary btn-sm" title="Minimizar" style="width:26px;height:26px;padding:0;display:flex;align-items:center;justify-content:center;">
                <i class="bi bi-chevron-down"></i>
              </button>
              <button id="refresh-progress-btn" class="btn btn-outline-secondary btn-sm" title="Atualizar" style="width:26px;height:26px;padding:0;display:flex;align-items:center;justify-content:center;">
                <i class="bi bi-arrow-clockwise"></i>
              </button>
              <button id="logout-btn" class="btn btn-outline-secondary btn-sm" title="Sair" style="width:26px;height:26px;padding:0;display:flex;align-items:center;justify-content:center;">
                <i class="bi bi-box-arrow-right"></i>
              </button>
            </div>
          </div>
        </div>
      </nav>
  <div class="mini-divider"></div>

  <div class="card config-card mb-2 border-0" style="display:none;">
        <div class="card-body p-2">
          <div class="row g-2">
            <div class="col-5">
              <label for="date" class="form-label small">Data</label>
              <input type="date" id="date" class="form-control form-control-sm config-input" />
            </div>
            <div class="col-3">
              <label for="start-time" class="form-label small">Início</label>
              <input type="time" id="start-time" class="form-control form-control-sm config-input" value="08:00" />
            </div>
            <div class="col-3">
              <label for="end-time" class="form-label small">Fim</label>
              <input type="time" id="end-time" class="form-control form-control-sm config-input" value="18:00" />
            </div>
            <div class="col-1 d-flex align-items-end">
              <span id="save-indicator" class="save-indicator w-100 text-center"></span>
            </div>
          </div>
          <!-- Ações só para manter IDs (ocultas) -->
          <div class="row g-2 mt-2" style="display:none;">
            <div class="col-4"><button id="history-btn" class="btn btn-action btn-outline-secondary w-100"><i class="bi bi-clock-history me-1"></i> Histórico</button></div>
            <div class="col-4"><button id="structure-btn" class="btn btn-action btn-outline-secondary w-100"><i class="bi bi-gear me-1"></i> Estrutura</button></div>
          </div>
        </div>
      </div>

  <div id="mini-expanded" class="mb-2">
        <div class="progress-container mb-2">
          <div class="progress-row">
            <div class="progress">
              <div id="progress-bar" class="progress-bar" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="150"></div>
            </div>
            <div class="progress-nums"><span id="current-ganhos">0</span>/<span class="target">150</span></div>
          </div>
          <div class="period-info text-center mt-1">
            <span class="period-label">Período:</span>
            <span id="week-dates" class="period-badge"></span>
            <span id="weekly-period" class="motivation-text"></span>
          </div>
        </div>
      </div>

  <!-- Divisor simples ao invés de cabeçalho de produtos -->
  <div class="mini-divider"></div>
  <div class="card products-card border-0">
        <div class="card-body p-2" style="padding-top:.25rem !important; padding-bottom:.25rem !important;">
          <!-- manter o elemento para compatibilidade, porém oculto -->
          <span id="products-count" class="d-none" aria-hidden="true"></span>
          <div id="products-grid" class="products-grid"></div>
        </div>
      </div>
    </section>
  </main>

  <!-- Toasts -->
  <div id="toast-container" class="toast-container position-fixed top-0 end-0 p-2" style="z-index:9999;"></div>

  <!-- Modals mínimos para compatibilidade -->
  <div class="modal fade" id="report-modal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h6 class="modal-title"><i class="bi bi-file-earmark-text me-1"></i> Gerar Relatório</h6>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-2 mb-2">
            <div class="col-6">
              <label for="report-date" class="form-label">Data</label>
              <input type="date" id="report-date" class="form-control" />
            </div>
            <div class="col-6 d-flex align-items-end">
              <div class="form-check">
                <input type="checkbox" id="sum-selected" class="form-check-input" checked />
                <label class="form-check-label" for="sum-selected">Somar contas selecionadas</label>
              </div>
            </div>
          </div>
          <label class="form-label">Contas</label>
          <div id="accounts-list" class="border rounded p-2 bg-light" style="max-height:250px;overflow:auto;"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button id="run-report-btn" type="button" class="btn btn-primary">Gerar</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="history-modal" tabindex="-1">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header bg-info text-white">
          <h6 class="modal-title"><i class="bi bi-clock-history me-1"></i> Histórico</h6>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-2 mb-2">
            <div class="col-5">
              <label for="hist-start" class="form-label">Início</label>
              <input type="date" id="hist-start" class="form-control" />
            </div>
            <div class="col-5">
              <label for="hist-end" class="form-label">Fim</label>
              <input type="date" id="hist-end" class="form-control" />
            </div>
            <div class="col-2 d-flex align-items-end">
              <button id="run-history-btn" class="btn btn-primary w-100">
                <i class="bi bi-search me-1"></i> Buscar
              </button>
            </div>
          </div>
          <div class="form-check mb-2">
            <input type="checkbox" id="hist-sum-period" class="form-check-input" />
            <label for="hist-sum-period" class="form-check-label">Somar todo o período</label>
          </div>
          <div id="history-results" class="history-results-container">
            <div class="text-center py-4 text-muted">
              <i class="bi bi-search fs-1 d-block mb-2"></i>
              <p>Use os filtros acima para buscar relatórios históricos</p>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="final-report-modal" tabindex="-1">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h6 class="modal-title"><i class="bi bi-file-earmark-text me-1"></i> Relatório Final</h6>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-2">
            <label for="final-report-text" class="form-label">Texto do Relatório</label>
            <textarea id="final-report-text" class="form-control" rows="12"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button id="copy-final-report-btn" type="button" class="btn btn-outline-primary">
            <i class="bi bi-clipboard"></i> Copiar Texto
          </button>
          <a id="whatsapp-final-link" class="btn btn-success" target="_blank" rel="noopener">
            <i class="bi bi-whatsapp"></i> Enviar no WhatsApp
          </a>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="structure-modal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-secondary text-white">
          <h6 class="modal-title"><i class="bi bi-box-seam me-1"></i> Editar Produtos/Interesses</h6>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-2">
            <button id="add-product-struct" class="btn btn-primary btn-sm">
              <i class="bi bi-plus-circle me-1"></i> Adicionar Produto
            </button>
          </div>
          <div id="structure-editor" class="structure-editor"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button id="save-structure-btn" class="btn btn-success">Salvar</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="weekly-history-modal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h6 class="modal-title"><i class="bi bi-calendar-week me-1"></i> Histórico de Metas Semanais</h6>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="weekly-history-loading" class="text-center py-4" style="display:none;">
            <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Carregando...</span></div>
          </div>
          <div id="weekly-history-content">
            <div class="table-responsive">
              <table class="table table-hover table-bordered align-middle" id="weekly-history-table">
                <thead class="table-light">
                  <tr>
                    <th>Período</th>
                    <th class="text-center">Meta</th>
                    <th class="text-center">Resultado</th>
                    <th class="text-center">Performance</th>
                    <th class="text-center">Status</th>
                  </tr>
                </thead>
                <tbody id="weekly-history-tbody"></tbody>
              </table>
            </div>
            <div id="weekly-history-empty" class="text-center py-5" style="display:none;">
              <i class="bi bi-calendar-x text-muted" style="font-size:3rem;"></i>
              <h6 class="text-muted mt-3">Nenhum histórico encontrado</h6>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase config and n8n config from parent root (reuse) -->
  <script src="../firebase-config.js"></script>
  <script src="../n8n-config.js"></script>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Reuse same main logic -->
  <script src="../main.js"></script>
  <script>
    // Mini-mode logic: toggle minimized view (progress-only) and notify parent for auto-resize
    (function(){
      const btn = document.getElementById('toggle-mini-btn');
      function notifyHeight(){
        try {
          // Altura real do documento (considerando conteúdos dinâmicos)
          const h = Math.max(
            document.documentElement.scrollHeight,
            document.body.scrollHeight,
            document.documentElement.offsetHeight
          );
          parent.postMessage({ type: 'rpv-mini-resize', height: h }, '*');
        } catch(_){}
      }
      const ro = new ResizeObserver(()=>notifyHeight());
      ro.observe(document.body);
      if (btn) {
        btn.addEventListener('click', ()=>{
          const root = document.documentElement;
          const collapsed = root.classList.toggle('mini-collapsed');
          btn.innerHTML = collapsed ? '<i class="bi bi-chevron-up"></i>' : '<i class="bi bi-chevron-down"></i>';
          setTimeout(notifyHeight, 50);
        });
      }
  window.addEventListener('load', ()=> setTimeout(notifyHeight, 120));
    })();
  </script>
</body>
</html>
